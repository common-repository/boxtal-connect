"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};!function(){var e={};e.api={ajaxUrl:null,getShippingMethodExtraLabelNonce:null,getPointsNonce:null,setPointNonce:null,setApiConfiguration:function(e,t,n,o){this.ajaxUrl=e,this.getShippingMethodExtraLabelNonce=t,this.getPointsNonce=n,this.setPointNonce=o},selectPoint:function(e,t,n,o,a,i,r,c,l,s,p,d,u){var h=this,g=new XMLHttpRequest;g.onreadystatechange=function(){if(4===g.readyState){var e=h.getRequestResponse(g);h.isValidResponse(e)?d({data:e.data,name:o,address:i,zipcode:r,city:c,distance:p}):u(e)}},g.open("POST",h.ajaxUrl),g.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),g.responseType="json",g.send("action=bw_set_point&carrier="+encodeURIComponent(e)+"&code="+encodeURIComponent(n)+"&name="+encodeURIComponent(o)+"&address="+encodeURIComponent(i)+"&zipcode="+encodeURIComponent(r)+"&city="+encodeURIComponent(c)+"&country="+encodeURIComponent(l)+"&openingHours="+encodeURIComponent(s)+"&network="+encodeURIComponent(a)+"&packageKey="+encodeURIComponent(t)+"&_wpnonce="+encodeURIComponent(h.setPointNonce))},getParcelPoints:function(e,t,n,o){var a=this,i=new XMLHttpRequest;i.onreadystatechange=function(){if(4===i.readyState){var e=a.getRequestResponse(i);a.isValidResponse(e)?n(e.data):o(e)}},i.open("POST",a.ajaxUrl),i.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),i.responseType="json",i.send("action=bw_get_points&carrier="+encodeURIComponent(e)+"&packageKey="+encodeURIComponent(t)+"&_wpnonce="+encodeURIComponent(a.getPointsNonce))},getShippingMethodExtraLabel:function(e,t,n,o){var a=this,i=new XMLHttpRequest;i.onreadystatechange=function(){if(4===i.readyState){var e=a.getRequestResponse(i);a.isValidResponse(e)?n(e.data):o(e)}},i.open("POST",a.ajaxUrl),i.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),i.responseType="json",i.send("action=bw_get_shipping_method_extra_label&shippingMethod="+encodeURIComponent(e)+"&packageKey="+encodeURIComponent(t)+"&_wpnonce="+encodeURIComponent(a.getShippingMethodExtraLabelNonce))},isValidResponse:function(e){return"object"===(void 0===e?"undefined":_typeof(e))&&null!==e&&!0===e.success&&"data"in e},getRequestResponse:function(e){return"object"===_typeof(e.response)&&null!==e.response?e.response:JSON.parse(e.response)}},e.util={on:function(e,t,n,o){if("undefined"!=typeof jQuery)jQuery(e).on(t,n,o);else{var a=document.querySelector(e);a.addEventListener(t,function(e){for(var t=a.querySelectorAll(n),i=e.target,r=0,c=t.length;r<c;r++)for(var l=i,s=t[r];l&&l!==a;){if(l===s)return o.call(s,e);l=l.parentNode}})}},observeDom:function(e,t,n){var o=void 0;return(o=new MutationObserver(function(e){var o=!0,a=!1,i=undefined;try{for(var r,c=e[Symbol.iterator]();!(o=(r=c.next()).done);o=!0){var l=r.value;if(t(l)){setTimeout(function(){return n()});break}}}catch(s){a=!0,i=s}finally{try{!o&&c["return"]&&c["return"]()}finally{if(a)throw i}}})).observe(e,{childList:!0,subtree:!0,attributes:!0,characterData:!1}),o},formatDistance:function(t){var n="undefined"!=typeof wp&&"i18n"in wp?wp.i18n.__("%skm away","boxtal-connect"):e.util.translate("%skm away"),o=null;return null!==t&&(t=Math.round(t/100)/10,isNaN(t)||(o=" ("+this.sprintf(n,t)+")")),o},formatParcelPoingAddress:function(t,n,o,a){var i=[t,[o,n].filter(function(e){return null!==e}).join(", ")].join(" ");return null!==(a=e.util.formatDistance(a))&&(i+=" "+a),i},fillSpaces:function(e,t){for(;e.length<t;)e+=" ";return e},formatOpeningDays:function(t){for(var n=[],o=e.util.fillSpaces("",11),a=0;a<t.length;a++){var i=t[a];if(i.weekday){for(var r=i.weekday[0]+" ",c=i.openingPeriods,l=[],s=0;s<c.length;s++){var p=c[s],d=p.openingTime===undefined?"":p.openingTime,u=p.closingTime===undefined?"":p.closingTime;""!==d&&""!==u?l.push(d+"-"+u):l.push(o)}r+=l.join(" "),a%2==1&&(r='<span style="background-color: #d8d8d8;">'+r+"</span>"),n.push(r)}}return'<pre class="bw-parcel-point-schedule">'+n.join("\n")+"</pre>"},formatHours:function(e){var t=e.split(":");return 3===t.length&&(e=t[0]+":"+t[1]),e},isWoocommerceBlocks:function(){return"wc"in window&&"blocksCheckout"in window.wc&&"wcSettings"in window.wc&&window.wc.wcSettings.getSetting("boxtal-connect-parcel-point_data")},isI18nEnabled:function(){return"undefined"!=typeof wp&&"i18n"in wp},translate:function(e){var t=e;return"undefined"!=typeof translations&&e in translations&&(t=translations[e]),t},sprintf:function(e){function t(t){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}(function(e){for(var t=arguments.length,n=Array(t>1?t-1:0),o=1;o<t;o++)n[o-1]=arguments[o];if("undefined"!=typeof sprintf)return sprintf.apply(undefined,[e].concat(n));var a=!0,i=!1,r=undefined;try{for(var c,l=n[Symbol.iterator]();!(a=(c=l.next()).done);a=!0){var s=c.value;e=e.replace("%s",s)}}catch(p){i=!0,r=p}finally{try{!a&&l["return"]&&l["return"]()}finally{if(i)throw r}}return e})},e.map={mapContainer:null,map:null,markers:[],mapUrl:null,mapLogoImageUrl:null,mapLogoHrefUrl:null,setMapConfiguration:function(e,t,n){this.mapUrl=e,this.mapLogoImageUrl=t,this.mapLogoHrefUrl=n},init:function(){var t=this,n=document.createElement("div");if(t.mapContainer=document.querySelector("#bw-map"),!t.mapContainer){var o=e.util.isI18nEnabled()?wp.i18n.__("Close map","boxtal-connect"):e.util.translate("Close map");n.setAttribute("class","bw-close"),n.setAttribute("title",o),n.addEventListener("click",function(){t.close()});var a=document.createElement("div");a.setAttribute("id","bw-map-canvas");var i=document.createElement("div");i.setAttribute("id","bw-map-container"),i.appendChild(a);var r=document.createElement("div");r.setAttribute("id","bw-pp-container");var c=document.createElement("div");c.setAttribute("id","bw-map-inner"),c.appendChild(n),c.appendChild(i),c.appendChild(r),t.mapContainer=document.createElement("div"),t.mapContainer.setAttribute("id","bw-map"),t.mapContainer.appendChild(c),document.body.appendChild(t.mapContainer),t.map=new mapboxgl.Map({container:"bw-map-canvas",style:t.mapUrl,zoom:14,accessToken:"whatever"}),t.map.addControl(new mapboxgl.NavigationControl);var l=document.createElement("img");l.setAttribute("src",t.mapLogoImageUrl);var s=document.createElement("a");s.setAttribute("href",t.mapLogoHrefUrl),s.setAttribute("target","_blank"),s.appendChild(l);var p=document.createElement("div");p.setAttribute("id","bw-logo"),p.appendChild(s);var d=document.querySelector(".mapboxgl-ctrl-top-left");d&&d.appendChild(p)}},open:function(){this.mapContainer.classList.add("bw-modal-show");var e=window.pageYOffset+(window.innerHeight-this.mapContainer.offsetHeight)/2;e<window.pageYOffset&&(e=window.pageYOffset),this.mapContainer.style.top=e+"px",this.map.resize()},close:function(){this.mapContainer.classList.remove("bw-modal-show"),this.clearMarkers()},addParcelPointMarkers:function(e){for(var t=0;t<e.length;t++)e[t].index=t,this.addParcelPointMarker(e[t])},addParcelPointMarker:function(t){var n=e.util.isI18nEnabled()?wp.i18n.__("Choose this parcel point","boxtal-connect"):e.util.translate("Choose this parcel point"),o=e.util.isI18nEnabled()?wp.i18n.__("Opening hours","boxtal-connect"):e.util.translate("Opening hours"),a='<div class="bw-marker-popup"><b>'+t.parcelPoint.name+'</b><br/><a href="#" class="bw-parcel-point-button" '+this.generateParcelPointTagData(t)+"><b>"+n+"</b></a><br/>"+t.parcelPoint.location.street+", "+t.parcelPoint.location.zipCode+" "+t.parcelPoint.location.city+"<br/><b>"+o+"</b><br/>";a+=e.util.formatOpeningDays(t.parcelPoint.openingDays);var i=this.getMarkerHtmlElement(t.index+1),r=new mapboxgl.Popup({offset:25}).setHTML(a),c=new mapboxgl.Marker({element:i,anchor:"bottom"}).setLngLat(new mapboxgl.LngLat(parseFloat(t.parcelPoint.location.position.longitude),parseFloat(t.parcelPoint.location.position.latitude))).setPopup(r).addTo(this.map);this.markers.push(c),this.addRightColMarkerEvent(c,t.parcelPoint.code)},generateParcelPointTagData:function(e){return' data-code="'+e.parcelPoint.code+'" data-name="'+encodeURIComponent(e.parcelPoint.name)+'" data-network="'+e.parcelPoint.network+'" data-zipcode="'+encodeURIComponent(e.parcelPoint.location.zipCode)+'" data-country="'+encodeURIComponent(e.parcelPoint.location.country)+'" data-city="'+encodeURIComponent(e.parcelPoint.location.city)+'" data-street="'+encodeURIComponent(e.parcelPoint.location.street)+'" data-openinghours="'+encodeURIComponent(JSON.stringify(e.parcelPoint.openingDays))+'" data-distance="'+encodeURIComponent(JSON.stringify(e.distanceFromSearchLocation))+'" '},addRightColMarkerEvent:function(t,n){e.util.on("body","click",".bw-show-info-"+n,function(){t.togglePopup()})},addRecipientMarker:function(e){var t=document.createElement("div");t.className="bw-marker-recipient";var n=new mapboxgl.Marker({element:t,anchor:"bottom"}).setLngLat(new mapboxgl.LngLat(parseFloat(e.position.longitude),parseFloat(e.position.latitude))).addTo(this.map);this.markers.push(n)},setMapBounds:function(){for(var e=new mapboxgl.LngLatBounds,t=0;t<this.markers.length;t++){var n=this.markers[t];e=e.extend(n.getLngLat())}this.map.fitBounds(e,{padding:30,linear:!0})},fillParcelPointPanel:function(t){var n=e.util.isI18nEnabled()?wp.i18n.__("Choose this parcel point","boxtal-connect"):e.util.translate("Choose this parcel point"),o="";o+="<table><tbody>";for(var a=0;a<t.length;a++){var i=t[a],r=e.util.formatDistance(i.distanceFromSearchLocation);o+="<tr>",o+="<td>"+this.getMarkerHtmlElement(a+1).outerHTML,o+='<div class="bw-parcel-point-title"><a class="bw-show-info-'+i.parcelPoint.code+'">'+i.parcelPoint.name+"</a></div><br/>",o+=i.parcelPoint.location.street+"<br/>",o+=i.parcelPoint.location.zipCode+" "+i.parcelPoint.location.city+(null!==r?r:"")+"<br/>",o+='<a class="bw-parcel-point-button" '+this.generateParcelPointTagData(i)+"><b>"+n+"</b></a>",o+="</td>",o+="</tr>"}o+="</tbody></table>",document.querySelector("#bw-pp-container").innerHTML=o},getMarkerHtmlElement:function(e){var t=document.createElement("div");return t.className="bw-marker",t.innerHTML=e,t},clearMarkers:function(){for(var e=0;e<this.markers.length;e++)this.markers[e].remove();this.markers=[]},getPoints:function(t,n,o){var a=this;e.api.getParcelPoints(t,n,function(e){a.addParcelPointMarkers(e.nearbyParcelPoints),a.fillParcelPointPanel(e.nearbyParcelPoints),a.addRecipientMarker(e.searchLocation),a.setMapBounds()},function(e){"object"===(void 0===e?"undefined":_typeof(e))&&"data"in e&&a.showError(e.data.message)})}},e.blocks={cache:{},loading:!1,init:function(){var t=this,n=(0,window.wc.wcSettings.getSetting)("boxtal-connect-parcel-point_data");if(n){e.api.setApiConfiguration(n.ajaxurl,n.getShippingMethodExtraLabelNonce,n.getPointsNonce,n.setPointNonce),e.map.setMapConfiguration(n.mapUrl,n.mapLogoImageUrl,n.mapLogoHrefUrl);var o=!1;t.onCartChange(function(){t.updateSelectedShippingMethodExtraLabel(),o||(o=!0,jQuery("body").on("input",t.getShippintMethodInputsSelector(),function(){return t.updateSelectedShippingMethodExtraLabel()}))}),jQuery("body").on("click",".bw-select-parcel",function(){e.map.init(),e.map.open(),t.getMapPoints()}),jQuery("body").on("click",".bw-parcel-point-button",function(){var n=wp.i18n.__,o=t.getSelectedShippingMethod(),a=t.getSelectedPackageKey();o||t.showError(n("Unable to find carrier","boxtal-connect")),e.api.selectPoint(o,a,this.getAttribute("data-code"),decodeURIComponent(this.getAttribute("data-name")),this.getAttribute("data-network"),decodeURIComponent(this.getAttribute("data-street")),decodeURIComponent(this.getAttribute("data-zipcode")),decodeURIComponent(this.getAttribute("data-city")),decodeURIComponent(this.getAttribute("data-country")),decodeURIComponent(this.getAttribute("data-openinghours")),decodeURIComponent(this.getAttribute("data-distance")),function(n){var i=n.data;t.updateShippingMethodExtraLabelCache(a,o,i.label),t.refreshShippingMethodExtraLabel(),e.map.close()},function(e){"object"===(void 0===e?"undefined":_typeof(e))&&"data"in e&&t.showError(e.data.message)})})}else console.error("[boxtal-connect] Failed to load plugin configuration (blocks)")},getMapPoints:function(){var t=wp.i18n.__,n=this,o=n.getSelectedShippingMethod(),a=n.getSelectedPackageKey();o&&null!==a||n.showError(t("Unable to find carrier","boxtal-connect")),e.map.getPoints(o,a,function(e){return n.showError(e)})},updateSelectedShippingMethodExtraLabel:function(){var t=wp.i18n.__,n=this;n.refreshShippingMethodExtraLabel();var o=n.getSelectedShippingMethod(),a=n.getSelectedPackageKey();o===undefined||a===undefined||n.loading||(n.loading=!0,e.api.getShippingMethodExtraLabel(o,a,function(e){n.updateShippingMethodExtraLabelCache(a,o,e.label),n.refreshShippingMethodExtraLabel(),n.loading=!1},function(){n.showError(t("Unable to find carrier","boxtal-connect")),n.loading=!1}))},getSelectedShippingMethod:function(){return jQuery(this.getShippintMethodInputsSelector()).filter(":checked").val()},getSelectedPackageKey:function(){var e=0,t=jQuery(this.getShippintMethodInputsSelector()).filter(":checked").attr("name");if(t){var n=t.split("-");e=n[n.length-1]}return e},getShippintMethodInputsSelector:function(){var e=this;return e.getShippingMethodsBlockClasses().map(function(t){return"."+t+" "+e.getShippintMethodsRadioControlSelector()}).join(", ")},getShippintMethodsBlockSelector:function(){return this.getShippingMethodsBlockClasses().map(function(e){return"."+e}).join(", ")},getShippintMethodTextLabelSelector:function(){return".wc-block-components-radio-control__label"},getShippingMethodsBlockClasses:function(){return["wp-block-woocommerce-checkout-shipping-methods-block","wp-block-woocommerce-cart-order-summary-shipping-block"]},getShippintMethodsRadioControlSelector:function(){return".wc-block-components-radio-control input"},showError:function(e){console.error(e)},onCartChange:function(t){var n=this;jQuery(n.getShippintMethodsBlockSelector()).filter(function(e,t){return n.isBlockReady(t)}).length>0&&t(),e.util.observeDom(document.body,function(e){var t=!1;if(e.addedNodes)for(var o=0;o<e.addedNodes.length;o++){var a=e.addedNodes[o];if(n.isBlockReady(a)){t=!0;break}}if(e.removedNodes&&!t)for(var i=0;i<e.removedNodes.length;i++){var r=e.removedNodes[i];if(n.isLoaderBlock(r)){t=!0;break}}return t},t)},isBlockReady:function(e){return this.getShippingMethodsBlockClasses().filter(function(t){return e.classList&&e.classList.contains(t)}).length>0&&jQuery(e).find(this.getShippintMethodsRadioControlSelector()).has(":checked")},isLoaderBlock:function(e){return e.classList&&e.classList.contains("wc-block-components-spinner")},updateShippingMethodExtraLabelCache:function(e,t,n){e in this.cache||(this.cache[e]={}),this.cache[e][t]=n},getShippingMethodCachedExtraLabel:function(e,t){return e in this.cache&&t in this.cache[e]?this.cache[e][t]:null},refreshShippingMethodExtraLabel:function(){var e=this.getSelectedShippingMethod(),t=this.getSelectedPackageKey(),n=this.getShippingMethodCachedExtraLabel(t,e);(jQuery(this.getShippintMethodsBlockSelector()).find("label "+this.getShippintMethodTextLabelSelector()).find(".bw-extra-label").remove(),null!==n)&&jQuery(this.getShippintMethodsBlockSelector()).find("label").has("input:checked").find(this.getShippintMethodTextLabelSelector()).first().append('<span class="bw-extra-label"><br/>'+n+"</span>")}},e.legacy={packageKey:null,init:function(){var t=this,n=t.getFrontendData();null!==n?(e.api.setApiConfiguration(n.ajaxurl,n.getShippingMethodExtraLabelNonce,n.getPointsNonce,n.setPointNonce),e.map.setMapConfiguration(n.mapUrl,n.mapLogoImageUrl,n.mapLogoHrefUrl),e.util.on("body","click",".bw-select-parcel",function(n){t.setPackageKey(n),e.map.init(),e.map.open(),t.getMapPoints()}),e.util.on("body","click",".bw-parcel-point-button",function(){var n=e.util.isI18nEnabled()?wp.i18n.__("Unable to find carrier","boxtal-connect"):e.util.translate("Unable to find carrier"),o=t.getSelectedCarrier();o||t.showError(n),e.api.selectPoint(o,t.packageKey,this.getAttribute("data-code"),decodeURIComponent(this.getAttribute("data-name")),this.getAttribute("data-network"),decodeURIComponent(this.getAttribute("data-street")),decodeURIComponent(this.getAttribute("data-zipcode")),decodeURIComponent(this.getAttribute("data-city")),decodeURIComponent(this.getAttribute("data-country")),decodeURIComponent(this.getAttribute("data-openinghours")),decodeURIComponent(this.getAttribute("data-distance")),function(n){var o=n.name,a=n.address,i=n.zipcode,r=n.city,c=n.distance;t.initSelectedParcelPoint();var l=document.querySelector(".bw-parcel-address-"+t.packageKey),s=document.querySelector(".bw-parcel-name-"+t.packageKey);l&&(l.innerHTML=e.util.formatParcelPoingAddress(a,r,i,c)),s&&(s.innerHTML=o),e.map.close()},function(e){"object"===(void 0===e?"undefined":_typeof(e))&&"data"in e&&t.showError(e.data.message)})})):console.error("[boxtal-connect] Failed to load plugin configuration (legacy)")},setPackageKey:function(e){this.packageKey=e.target.attributes.getNamedItem("data-package_key").value},getFrontendData:function(){var e=null;if("undefined"!=typeof bwData)e=bwData;else if("wc"in window&&"wcSettings"in window.wc){var t=window.wc.wcSettings.getSetting("boxtal-connect-parcel-point_data");t&&(e=t)}return e},initSelectedParcelPoint:function(){var t=e.util.isI18nEnabled()?wp.i18n.__("Your parcel point:","boxtal-connect"):e.util.translate("Your parcel point:"),n=document.querySelector(".bw-parcel-client-"+this.packageKey);n.innerHTML=t+" ";var o=document.createElement("span");o.setAttribute("class","bw-parcel-name-"+this.packageKey),n.appendChild(o)},getMapPoints:function(){var t=this,n=e.util.isI18nEnabled()?wp.i18n.__("Unable to find carrier","boxtal-connect"):e.util.translate("Unable to find carrier"),o=t.getSelectedCarrier();o||t.showError(n),e.map.getPoints(o,t.packageKey,function(e){return t.showError(e)})},getSelectedCarrier:function(){var e=void 0,t=document.querySelector('input[type="hidden"].shipping_method');t?e=t.getAttribute("value"):e=document.querySelector("input.shipping_method:checked").getAttribute("value");return e},showError:function(t){e.map.close(),alert(t)}},document.addEventListener("DOMContentLoaded",function(){e.util.isWoocommerceBlocks()?e.blocks.init():e.legacy.init()})}();